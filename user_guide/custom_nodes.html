<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Creating Custom Node Types &mdash; hippynn 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=e3456cac" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=8df938ec"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="hippynn package" href="../api_documentation/hippynn.html" />
    <link rel="prev" title="Library Settings" href="settings.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            hippynn
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">How to install hippynn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="features.html">hippynn Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html">hippynn Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="databases.html">Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="loss_graph.html">Model and Loss Graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html">Units in hippynn</a></li>
<li class="toctree-l2"><a class="reference internal" href="ckernels.html">Custom Kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="settings.html">Library Settings</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Creating Custom Node Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-very-basics">The very basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-multinode">A MultiNode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parent-expansion">Parent expansion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-constraints-to-possible-parents">Adding constraints to possible parents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_documentation/hippynn.html">hippynn API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hippynn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">User Guide</a></li>
      <li class="breadcrumb-item active">Creating Custom Node Types</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user_guide/custom_nodes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="settings.html" class="btn btn-neutral float-left" title="Library Settings" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api_documentation/hippynn.html" class="btn btn-neutral float-right" title="hippynn package" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="creating-custom-node-types">
<h1>Creating Custom Node Types<a class="headerlink" href="#creating-custom-node-types" title="Permalink to this heading"></a></h1>
<p>For applications of existing models or methods you shouldn’t need
to create new <em>types</em> of nodes. However, if you want to extend
the capabilities of the library for your own application
(or as part of a contribution to this library) then you
may find yourself wanting to put a new type of node into
<code class="docutils literal notranslate"><span class="pre">hippynn</span></code>.</p>
<section id="the-very-basics">
<h2>The very basics<a class="headerlink" href="#the-very-basics" title="Permalink to this heading"></a></h2>
<p>The basic operation of creating a new hippynn node is not highly complex.
Let’s assume we have a module FooModule that implements some pytorch operations,
and takes some keyword arguments in constructing that module.
A simple node could be built as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hippynn.graphs.nodes.base</span> <span class="kn">import</span> <span class="n">SingleNode</span>
<span class="kn">from</span> <span class="nn">hippynn.graphs</span> <span class="kn">import</span> <span class="n">IdxType</span>
<span class="k">class</span> <span class="nc">FooNode</span><span class="p">(</span><span class="n">SingleNode</span><span class="p">):</span>
    <span class="n">_index_state</span> <span class="o">=</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Atom</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">parents</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">parents</span><span class="p">,</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>At a basic level, that’s it. However, the parents of this node are completely unspecified;
there is no information about what tensors should go into the FooModule. Note that at this level,
the module itself is not created when building the node, and a suitable pytorch module
must be passed in.</p>
</section>
<section id="a-multinode">
<h2>A MultiNode<a class="headerlink" href="#a-multinode" title="Permalink to this heading"></a></h2>
<p>A slightly more complex example would be to use a <code class="docutils literal notranslate"><span class="pre">MultiNode</span></code>, which is a torch
module that outputs several outputs. Specify the names of the outputs in the
<code class="docutils literal notranslate"><span class="pre">_output_names</span></code> attribute as a tuple of strings. Additionally, you can
specify the <code class="docutils literal notranslate"><span class="pre">IdxType</span></code> of the outputs so that other nodes can recognize
what type of information is provided. Here is a stripped-down version of the
hierarchical energy regression target <a class="reference internal" href="../api_documentation/hippynn.graphs.nodes.targets.html#hippynn.graphs.nodes.targets.HEnergyNode" title="hippynn.graphs.nodes.targets.HEnergyNode"><code class="xref py py-class docutils literal notranslate"><span class="pre">HEnergyNode</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hippynn.layers.targets</span> <span class="k">as</span> <span class="nn">target_modules</span>
<span class="kn">from</span> <span class="nn">hippynn.graphs.nodes</span> <span class="kn">import</span> <span class="n">MultiNode</span>
<span class="kn">from</span> <span class="nn">hippynn.graphs.nodes.base.definition_helpers</span> <span class="kn">import</span> <span class="n">AutoKw</span>

<span class="k">class</span> <span class="nc">SimpleHEnergyNode</span><span class="p">(</span><span class="n">AutoKw</span><span class="p">,</span> <span class="n">MultiNode</span><span class="p">):</span>
    <span class="n">_input_names</span> <span class="o">=</span> <span class="s2">&quot;hier_features&quot;</span><span class="p">,</span> <span class="s2">&quot;mol_index&quot;</span><span class="p">,</span> <span class="s2">&quot;n_molecules&quot;</span>
    <span class="n">_output_names</span> <span class="o">=</span> <span class="s2">&quot;mol_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;atom_energies&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_terms&quot;</span><span class="p">,</span> <span class="s2">&quot;hierarchicality&quot;</span>
    <span class="n">_main_output</span> <span class="o">=</span> <span class="s2">&quot;mol_energy&quot;</span>
    <span class="n">_output_index_states</span> <span class="o">=</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Molecules</span>
    <span class="n">_auto_module_class</span> <span class="o">=</span> <span class="n">target_modules</span><span class="o">.</span><span class="n">HEnergy</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">module_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span> <span class="o">=</span> <span class="n">module_kwargs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we have added the _input_names tuple as well, this attribute can be set on
SingleNode and MultiNode classes.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">_main_output</span></code> attribute specifies what tensor to use by default when sending information
to a child node. This class also makes use of the <code class="docutils literal notranslate"><span class="pre">AutoKw</span></code> mix-in for defining a new module
using keyword arguments. These arguments will be passed to a new instance of the attribute
<code class="docutils literal notranslate"><span class="pre">auto_module_class</span></code>.</p>
</section>
<section id="parent-expansion">
<h2>Parent expansion<a class="headerlink" href="#parent-expansion" title="Permalink to this heading"></a></h2>
<p>The above example works, however, it 1) requires the user to find the appropriate
input nodes corresponding to <code class="docutils literal notranslate"><span class="pre">hier_features</span></code>, <code class="docutils literal notranslate"><span class="pre">mol_index</span></code>, <code class="docutils literal notranslate"><span class="pre">n_molecules</span></code>, which are
required to run the underlying torch module.</p>
<p>The features will usually come from a network, and the molecule index and number of molecules
in a batch are processed by the padding indexer. We can use the <code class="docutils literal notranslate"><span class="pre">ExpandParents</span></code> class
to make invoking this node easier.</p>
<p>Let’s take a look  at the full definition of <a class="reference internal" href="../api_documentation/hippynn.graphs.nodes.targets.html#hippynn.graphs.nodes.targets.HEnergyNode" title="hippynn.graphs.nodes.targets.HEnergyNode"><code class="xref py py-class docutils literal notranslate"><span class="pre">HEnergyNode</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HEnergyNode</span><span class="p">(</span><span class="n">Energies</span><span class="p">,</span> <span class="n">HAtomRegressor</span><span class="p">,</span> <span class="n">AutoKw</span><span class="p">,</span> <span class="n">ExpandParents</span><span class="p">,</span> <span class="n">MultiNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict a system-level scalar such as energy from a sum over local components.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_input_names</span> <span class="o">=</span> <span class="s2">&quot;hier_features&quot;</span><span class="p">,</span> <span class="s2">&quot;mol_index&quot;</span><span class="p">,</span> <span class="s2">&quot;n_molecules&quot;</span>
    <span class="n">_output_names</span> <span class="o">=</span> <span class="s2">&quot;mol_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;atom_energies&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_terms&quot;</span><span class="p">,</span> <span class="s2">&quot;hierarchicality&quot;</span><span class="p">,</span> <span class="s2">&quot;atom_hier&quot;</span><span class="p">,</span> <span class="s2">&quot;mol_hier&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_hier&quot;</span>
    <span class="n">_main_output</span> <span class="o">=</span> <span class="s2">&quot;mol_energy&quot;</span>
    <span class="n">_output_index_states</span> <span class="o">=</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Molecules</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Scalar</span>
    <span class="n">_auto_module_class</span> <span class="o">=</span> <span class="n">target_modules</span><span class="o">.</span><span class="n">HEnergy</span>

    <span class="nd">@_parent_expander</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Network</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expansion0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;feature_sizes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span><span class="p">[</span><span class="s2">&quot;feature_sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">torch_module</span><span class="o">.</span><span class="n">feature_sizes</span>
        <span class="n">pdindexer</span> <span class="o">=</span> <span class="n">find_unique_relative</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">AtomIndexer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">net</span><span class="p">,</span> <span class="n">pdindexer</span><span class="o">.</span><span class="n">mol_index</span><span class="p">,</span> <span class="n">pdindexer</span><span class="o">.</span><span class="n">n_molecules</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">first_is_interacting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">module_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;first_is_interacting&quot;</span><span class="p">:</span> <span class="n">first_is_interacting</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">module_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">module_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">module_kwargs</span><span class="p">}</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_parents</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The parent classes <code class="docutils literal notranslate"><span class="pre">Energies</span></code> and <code class="docutils literal notranslate"><span class="pre">HAtomRegressor</span></code> do not add any methods, they
are simply mixin tags so that it is easy to find nodes based on their type. The key
additional superclass is <code class="docutils literal notranslate"><span class="pre">ExpandParents</span></code>, which automatically provides the class with
a <code class="docutils literal notranslate"><span class="pre">_parent_expander</span></code> attribute that is an instance of a parent expander.
We then define a method called (arbitrarily) <code class="docutils literal notranslate"><span class="pre">expansion0</span></code> which is decorated by the parent
expander to be run when the form of the parents matches the given one, in this case,
a single parent with node type <code class="docutils literal notranslate"><span class="pre">Network</span></code>. The function does two things.</p>
<ol class="arabic simple">
<li><p>It sets the value of the feature sizes for the underlying torch module based on those found
in the network, if they have not already been defined.</p></li>
<li><p>It attempts to find a unique <code class="docutils literal notranslate"><span class="pre">AtomIndexer</span></code> object which is connected to the network node,
and gets the outputs <code class="docutils literal notranslate"><span class="pre">mol_index</span></code> and <code class="docutils literal notranslate"><span class="pre">n_molecules</span></code> from that object.</p></li>
</ol>
<p>A key aspect is that <code class="docutils literal notranslate"><span class="pre">expansion0</span></code> is only run if the parents match this form. If
a different form is found, the function is skipped. This way if we arise at a complex
model definition where there are multiple AtomIndexers or none whatsoever, but the inputs
to the node can be provided by some other route, we can always pass the fully specified
parents of the node, <code class="docutils literal notranslate"><span class="pre">hier_features</span></code>, <code class="docutils literal notranslate"><span class="pre">mol_index</span></code>, and <code class="docutils literal notranslate"><span class="pre">n_molecules</span></code>.</p>
</section>
<section id="adding-constraints-to-possible-parents">
<h2>Adding constraints to possible parents<a class="headerlink" href="#adding-constraints-to-possible-parents" title="Permalink to this heading"></a></h2>
<p>Finally, it is possible to add additional information to the parent expander
to ensure that the final form of the parents is suitable for computation.</p>
<p>Let’s take a look at the code for <a class="reference internal" href="../api_documentation/hippynn.graphs.nodes.physics.html#hippynn.graphs.nodes.physics.ChargeMomentNode" title="hippynn.graphs.nodes.physics.ChargeMomentNode"><code class="xref py py-class docutils literal notranslate"><span class="pre">ChargeMomentNode</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ChargeMomentNode</span><span class="p">(</span><span class="n">ExpandParents</span><span class="p">,</span> <span class="n">AutoNoKw</span><span class="p">,</span> <span class="n">SingleNode</span><span class="p">):</span>
    <span class="n">_input_names</span> <span class="o">=</span> <span class="s2">&quot;charges&quot;</span><span class="p">,</span> <span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;mol_index&quot;</span><span class="p">,</span> <span class="s2">&quot;n_molecules&quot;</span>

    <span class="nd">@_parent_expander</span><span class="o">.</span><span class="n">matchlen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expansion0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">purpose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">charges</span><span class="p">,</span> <span class="n">find_unique_relative</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span> <span class="n">PositionsNode</span><span class="p">,</span> <span class="n">why_desc</span><span class="o">=</span><span class="n">purpose</span><span class="p">)</span>

    <span class="nd">@_parent_expander</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Charges</span><span class="p">,</span> <span class="n">PositionsNode</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expansion1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">purpose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">enc</span><span class="p">,</span> <span class="n">pidxer</span> <span class="o">=</span> <span class="n">acquire_encoding_padding</span><span class="p">((</span><span class="n">charges</span><span class="p">,</span> <span class="n">positions</span><span class="p">),</span> <span class="n">species_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="n">purpose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">charges</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">pidxer</span>

    <span class="nd">@_parent_expander</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Charges</span><span class="p">,</span> <span class="n">PositionsNode</span><span class="p">,</span> <span class="n">AtomIndexer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expansion2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">pdxer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">charges</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">pdxer</span><span class="o">.</span><span class="n">mol_index</span><span class="p">,</span> <span class="n">pdxer</span><span class="o">.</span><span class="n">n_molecules</span>

    <span class="n">_parent_expander</span><span class="o">.</span><span class="n">assertlen</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">_parent_expander</span><span class="o">.</span><span class="n">get_main_outputs</span><span class="p">()</span>
    <span class="n">_parent_expander</span><span class="o">.</span><span class="n">require_idx_states</span><span class="p">(</span><span class="n">IdxType</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span> <span class="n">IdxType</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_parents</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the base class for the Dipole and Quadrupole Nodes. It uses several parent expansion functions:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;_parent_expander.match()</span></code>: Decorates a function to be used by the parent expansion
if the type is matched. The returned values should be the new set of parents for the node.
A function doesn’t -have- to modify the set of parents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_parent_expander.assertlen()</span></code>: Assert that there are a given number of parents for the node.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_parent_expander.get_main_outputs()</span></code>: If there are any MultiNodes in the parent set,
replace them with their main outputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_parent_expander.require_idx_states()</span></code>: Throw an error if the index states of the parents
do not match a specific form. Additionally, if the current index state can be converted to
the needed index state, this conversion will automatically be applied using
<a class="reference internal" href="../api_documentation/hippynn.graphs.indextypes.html#hippynn.graphs.indextypes.index_type_coercion" title="hippynn.graphs.indextypes.index_type_coercion"><code class="xref py py-func docutils literal notranslate"><span class="pre">index_type_coercion()</span></code></a>.</p></li>
</ol>
<p>A full list of available methods is  at the API documentation for the
<a class="reference internal" href="../api_documentation/hippynn.graphs.nodes.base.definition_helpers.html#hippynn.graphs.nodes.base.definition_helpers.ParentExpander" title="hippynn.graphs.nodes.base.definition_helpers.ParentExpander"><code class="xref py py-func docutils literal notranslate"><span class="pre">ParentExpander()</span></code></a>.
These directives are executed when the node’s <code class="docutils literal notranslate"><span class="pre">expand_parents</span></code> method is run, which
should be performed <em>before</em> calling to the <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code> method.
In combination, these directives allow for a powerful flexibility in building graphs
so that where possible, information is re-used or automatically generated in order
to simplify the syntax of invoking the node from a user perspective, but still allow
for a complete and unambiguous definition of node parents when in cases where it is
called for.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="settings.html" class="btn btn-neutral float-left" title="Library Settings" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api_documentation/hippynn.html" class="btn btn-neutral float-right" title="hippynn package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Los Alamos National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>